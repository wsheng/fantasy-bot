name: Daily Lineup Optimizer

on:
  schedule:
    # 10:00 UTC = 2:00 AM PT
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  optimize:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Write credentials from secrets
        env:
          YAHOO_CONSUMER_KEY: ${{ secrets.YAHOO_CONSUMER_KEY }}
          YAHOO_CONSUMER_SECRET: ${{ secrets.YAHOO_CONSUMER_SECRET }}
          YAHOO_REFRESH_TOKEN: ${{ secrets.YAHOO_REFRESH_TOKEN }}
          YAHOO_LEAGUE_ID: ${{ secrets.YAHOO_LEAGUE_ID }}
          YAHOO_TEAM_NAME: ${{ secrets.YAHOO_TEAM_NAME }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          python - <<'PYEOF'
          import json, os
          # Write .env
          env_keys = [
              ("YAHOO_CLIENT_ID", "YAHOO_CONSUMER_KEY"),
              ("YAHOO_CLIENT_SECRET", "YAHOO_CONSUMER_SECRET"),
              ("YAHOO_LEAGUE_ID", "YAHOO_LEAGUE_ID"),
              ("YAHOO_TEAM_NAME", "YAHOO_TEAM_NAME"),
              ("GMAIL_USER", "GMAIL_USER"),
              ("GMAIL_APP_PASSWORD", "GMAIL_APP_PASSWORD"),
              ("NOTIFY_EMAIL", "NOTIFY_EMAIL"),
          ]
          with open(".env", "w") as f:
              for dotenv_key, gh_key in env_keys:
                  f.write(f"{dotenv_key}={os.environ[gh_key]}\n")
          os.chmod(".env", 0o600)
          # Write oauth2.json
          oauth = {
              "access_token": "expired",
              "consumer_key": os.environ["YAHOO_CONSUMER_KEY"],
              "consumer_secret": os.environ["YAHOO_CONSUMER_SECRET"],
              "guid": None,
              "refresh_token": os.environ["YAHOO_REFRESH_TOKEN"],
              "token_time": 0,
              "token_type": "bearer",
          }
          with open("oauth2.json", "w") as f:
              json.dump(oauth, f, indent=4)
          os.chmod("oauth2.json", 0o600)
          PYEOF

      - name: Run daily optimizer
        run: python main.py
